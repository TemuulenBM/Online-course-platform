# =============================================================================
# Production Deploy — Гараар эхлүүлнэ (Actions tab → Run workflow)
# GitHub Environment protection rules-ээр reviewer approval шаардана
# =============================================================================
name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Deploy хийх image tag (default: staging)'
        required: false
        default: 'staging'

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  API_IMAGE: ghcr.io/${{ github.repository_owner }}/ocp-api
  WEB_IMAGE: ghcr.io/${{ github.repository_owner }}/ocp-web

jobs:
  # ─── Production image tag хийх ───
  tag-production:
    name: Tag Production Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: GHCR нэвтрэх
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: API image-д production tag нэмэх
        run: |
          docker pull ${{ env.API_IMAGE }}:${{ inputs.tag }}
          docker tag ${{ env.API_IMAGE }}:${{ inputs.tag }} ${{ env.API_IMAGE }}:production
          docker tag ${{ env.API_IMAGE }}:${{ inputs.tag }} ${{ env.API_IMAGE }}:production-$(date +%Y%m%d-%H%M%S)
          docker push ${{ env.API_IMAGE }}:production
          docker push ${{ env.API_IMAGE }}:production-$(date +%Y%m%d-%H%M%S)

      - name: Web image-д production tag нэмэх
        run: |
          docker pull ${{ env.WEB_IMAGE }}:${{ inputs.tag }}
          docker tag ${{ env.WEB_IMAGE }}:${{ inputs.tag }} ${{ env.WEB_IMAGE }}:production
          docker tag ${{ env.WEB_IMAGE }}:${{ inputs.tag }} ${{ env.WEB_IMAGE }}:production-$(date +%Y%m%d-%H%M%S)
          docker push ${{ env.WEB_IMAGE }}:production
          docker push ${{ env.WEB_IMAGE }}:production-$(date +%Y%m%d-%H%M%S)

  # ─── Production server дээр deploy хийх ───
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: tag-production
    environment: production  # GitHub Environment — required reviewers тохируулах

    steps:
      - name: Production server руу deploy хийх
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd ${{ secrets.PRODUCTION_APP_DIR }}
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose -f docker-compose.prod.yml pull api web
            docker compose -f docker-compose.prod.yml up -d api web
            docker image prune -f

      - name: Database migration ажиллуулах
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd ${{ secrets.PRODUCTION_APP_DIR }}
            docker compose -f docker-compose.prod.yml exec -T api npx prisma migrate deploy --config prisma/prisma.config.ts

      - name: Health check шалгах
        run: |
          echo "Production server-ийн health check шалгаж байна..."
          sleep 15
          for i in {1..5}; do
            if curl -sf ${{ secrets.PRODUCTION_URL }}/api/v1; then
              echo "Production health check амжилттай!"
              exit 0
            fi
            echo "Оролдлого $i амжилтгүй, 10 секунд хүлээж байна..."
            sleep 10
          done
          echo "Production health check амжилтгүй — rollback шаардлагатай!"
          exit 1
